name: Deploy Streamlit App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]

env:
  APP_VERSION: ${{ github.ref_name || 'development' }}

jobs:
  version-check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Get Version
      id: get-version
      run: |
        if [ -f VERSION ]; then
          VERSION=$(python -c "import json; print(json.load(open('VERSION'))['version'])")
        else
          VERSION="unknown"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"

  test:
    needs: version-check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Version Info
      run: |
        echo "Testing version: ${{ needs.version-check.outputs.version }}"
        python scripts/update_version.py --current
    
    - name: Run tests
      run: |
        # ê¸°ë³¸ import í…ŒìŠ¤íŠ¸
        python -c "import streamlit; import pandas; import plotly"
        # ì•± êµ¬ë¬¸ ê²€ì‚¬
        python -m py_compile streamlit_app.py
    
    - name: Check code quality
      run: |
        pip install flake8
        # E501 (line too long) ë¬´ì‹œ
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
  
  auto-version-update:
    needs: [test, version-check]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Auto Version Update
      run: |
        # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ë²„ì „ íƒ€ì… ê°ì§€
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        
        if [[ $COMMIT_MSG == *"BREAKING CHANGE"* ]] || [[ $COMMIT_MSG == *"major:"* ]]; then
          VERSION_TYPE="major"
        elif [[ $COMMIT_MSG == *"feat:"* ]] || [[ $COMMIT_MSG == *"feature:"* ]]; then
          VERSION_TYPE="minor"
        else
          VERSION_TYPE="patch"
        fi
        
        echo "Detected version type: $VERSION_TYPE"
        
        # ë²„ì „ ì—…ë°ì´íŠ¸
        python scripts/update_version.py --type $VERSION_TYPE --changelog "$COMMIT_MSG"
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "chore: auto-update version"
          git push
        fi

  deploy:
    needs: [test, version-check]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Streamlit Cloud
      run: |
        echo "Deploying version ${{ needs.version-check.outputs.version }} to Streamlit Cloud"
        # Streamlit Cloud ìë™ ë°°í¬ëŠ” ì—°ê²°ëœ GitHub ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ìë™ ì‹¤í–‰ë¨
    
    # Docker Hubì— ë°°í¬í•˜ëŠ” ê²½ìš°
    - name: Build and push Docker image
      if: false  # í•„ìš”ì‹œ trueë¡œ ë³€ê²½
      run: |
        docker build -t spsystems/analysis-tool:${{ needs.version-check.outputs.version }} .
        docker build -t spsystems/analysis-tool:latest .
        # docker push spsystems/analysis-tool:${{ needs.version-check.outputs.version }}
        # docker push spsystems/analysis-tool:latest

  create-release:
    needs: [test, version-check]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create Release
      if: contains(github.event.head_commit.message, 'release:')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.version-check.outputs.version }}
        release_name: Release v${{ needs.version-check.outputs.version }}
        body: |
          ## ğŸš€ Release v${{ needs.version-check.outputs.version }}
          
          ### ğŸ“‹ ë³€ê²½ì‚¬í•­
          ${{ github.event.head_commit.message }}
          
          ### ğŸ› ï¸ ê¸°ìˆ  ì •ë³´
          - **ì»¤ë°‹**: ${{ github.sha }}
          - **ê°œë°œíŒ€**: SPsystems ì—°êµ¬ì†Œ ê°œë°œíŒ€
          - **ë¹Œë“œ ë‚ ì§œ**: ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false
